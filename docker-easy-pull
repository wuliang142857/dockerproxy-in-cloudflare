#!/usr/bin/env python3
"""
docker-easy-pull - Easily pull Docker images through mirror registries
"""

import sys
import json
import subprocess
import urllib.request
import urllib.parse
from typing import Optional, Dict, List

API_URL = "https://docker.aityp.com/api/v1/image"
PREFERRED_PLATFORM = "linux/amd64"


def query_mirror(image_name: str) -> Optional[Dict]:
    """Query the API for available mirrors of the given image."""
    url = f"{API_URL}?search={urllib.parse.quote(image_name)}"

    try:
        print(f"üîç Searching for image: {image_name}")
        with urllib.request.urlopen(url, timeout=10) as response:
            data = json.loads(response.read().decode())

        if data.get('error') is False and data.get('count', 0) > 0:
            return data
        else:
            print(f"‚ùå No mirror found for image: {image_name}")
            return None
    except Exception as e:
        print(f"‚ùå Error querying API: {e}")
        return None


def select_best_mirror(results: List[Dict]) -> Optional[Dict]:
    """Select the best mirror from results, preferring the specified platform."""
    if not results:
        return None

    # Try to find preferred platform
    for result in results:
        if result.get('platform') == PREFERRED_PLATFORM:
            return result

    # Fallback to first result
    return results[0]


def run_command(cmd: List[str], description: str) -> bool:
    """Run a shell command and return success status."""
    print(f"üîß {description}")
    try:
        result = subprocess.run(cmd, check=True, capture_output=True, text=True)
        return True
    except subprocess.CalledProcessError as e:
        print(f"‚ùå Command failed: {' '.join(cmd)}")
        if e.stderr:
            print(f"   Error: {e.stderr}")
        return False


def pull_and_retag(original_image: str, mirror_image: str) -> bool:
    """Pull image from mirror and retag to original name."""

    # Step 1: Pull from mirror
    if not run_command(
        ['docker', 'pull', mirror_image],
        f"Pulling from mirror: {mirror_image}"
    ):
        return False

    # Step 2: Tag with original name
    if not run_command(
        ['docker', 'tag', mirror_image, original_image],
        f"Tagging as: {original_image}"
    ):
        return False

    # Step 3: Remove mirror tag
    if not run_command(
        ['docker', 'rmi', mirror_image],
        f"Removing temporary tag: {mirror_image}"
    ):
        print("‚ö†Ô∏è  Warning: Failed to remove temporary tag, but image is available")

    return True


def main():
    if len(sys.argv) < 2:
        print("Usage: docker-easy-pull <image:tag>")
        print("Example: docker-easy-pull ubuntu:24.04")
        print("Example: docker-easy-pull gcr.io/google-containers/coredns:1.2.4")
        sys.exit(1)

    original_image = sys.argv[1]

    # Ensure image has a tag
    if ':' not in original_image:
        original_image = f"{original_image}:latest"
        print(f"‚ÑπÔ∏è  No tag specified, using: {original_image}")

    # Query API
    data = query_mirror(original_image)
    if not data:
        sys.exit(1)

    # Select best mirror
    mirror_info = select_best_mirror(data.get('results', []))
    if not mirror_info:
        print("‚ùå No suitable mirror found")
        sys.exit(1)

    mirror_image = mirror_info['mirror']
    platform = mirror_info.get('platform', 'unknown')
    size = mirror_info.get('size', 'unknown')

    print(f"‚úÖ Found mirror: {mirror_image}")
    print(f"   Platform: {platform}")
    print(f"   Size: {size}")

    # Pull and retag
    if pull_and_retag(original_image, mirror_image):
        print(f"‚úÖ Successfully pulled: {original_image}")
        print(f"\nYou can now use: docker run {original_image}")
    else:
        print("‚ùå Failed to pull and retag image")
        sys.exit(1)


if __name__ == "__main__":
    main()
